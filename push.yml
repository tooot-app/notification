version: '3'
services:
  caddy:
    image: caddy:2-alpine
    networks:
      - external_network
      - internal_network
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./data/caddy/config:/config
      - ./data/caddy/data:/data
    deploy:
      placement:
        constraints:
          - node.hostname == tooot-push-1

  db:
    image: postgres:13-alpine
    networks:
      - internal_network
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    env_file: .env
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'postgres']
    deploy:
      placement:
        constraints:
          - node.hostname == tooot-push-1

  redis:
    image: redis:6-alpine
    networks:
      - internal_network
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
    deploy:
      placement:
        constraints:
          - node.hostname == tooot-push-1

  push:
    image: ghcr.io/tooot-app/push:latest
    networks:
      - external_network
      - internal_network
    depends_on:
      - db
      - redis
    env_file: .env
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/v1/health || exit 1"]
    deploy:
      placement:
        constraints:
          - node.hostname == tooot-push-1

networks:
  external_network:
  internal_network:
    internal: true
